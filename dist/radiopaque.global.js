Radiopaque = (function(){
var module = {};

function Radiopaque(){this.m_channel=null,this.m_audience=null,this.q={dt:0,currentTime:0,latestTime:0},this.messages=[],this.audiences=[],this.channels={},this.subscribers={},this.audienceSubscribers={}}function PreparedBroadcast(r,filler,template){this.r=r,this.filler=filler,this.template=template||{}}var clone=function(obj){var result={};for(var i in obj)result[i]=obj[i];return result},_p=Radiopaque.prototype;_p.subscribe=function(callback){if(null===this.m_channel)throw new Error("cannot subscribe without channel modifier");if(void 0===this.subscribers[this.m_channel]&&(this.subscribers[this.m_channel]=[]),this.subscribers[this.m_channel].push(callback),null!==this.m_audience){void 0===this.audienceSubscribers[this.m_audience]&&(this.audienceSubscribers[this.m_audience]=[]);var audienceSubscribers=this.audienceSubscribers[this.m_audience];void 0===audienceSubscribers[this.m_channel]&&(audienceSubscribers[this.m_channel]=[]),audienceSubscribers[this.m_channel].push(callback)}return this},_p.broadcast=function(payload){if(null===this.m_channel)throw new Error("cannot broadcast without channel modifier");if(void 0!==this.subscribers[this.m_channel])for(var subscribers=this.subscribers[this.m_channel],i=0,len=subscribers.length;len>i;i++)subscribers[i].call(this,payload)},_p.e_unsubscribe=function(callback){if(null===this.m_channel)throw new Error("cannot subscribe without channel modifier");if(this.subscribers[this.m_channel]instanceof Array){var subscribers=this.subscribers[this.m_channel],index=subscribers.indexOf(callback);~index&&subscribers.splice(index,1)}},_p.unsubscribe=function(callback){this.e_unsubscribe(callback);for(var i in this.audienceSubscribers){var channelSubscribers=this.audienceSubscribers[this.m_channel];if(channelSubscribers){var index=channelSubscribers.indexOf(callback);~index&&channelSubscribers.splice(index,1)}}return this},_p.unsubscribeAll=function(){if(null===this.m_audience)throw new Error("cannot unsubscribeAll without audience modifier");this.audiences[this.m_audience]=null;var audienceSubscribers=this.audienceSubscribers[this.m_audience];if(audienceSubscribers){for(var channel in audienceSubscribers)for(var channelO=this.channel(channel),i=0;i<audienceSubscribers[channel].length;i++)channelO.e_unsubscribe(audienceSubscribers[channel][i]);this.audienceSubscribers[this.m_audience]={}}},_p.prepare=function(filler,template){return new PreparedBroadcast(this,filler,template)},_p.subscribeObject=function(obj,channels){for(var i=0;i<channels.length;i++){var channel=channels[i],method="on"+channel[0].toUpperCase()+channel.substring(1);if("function"!=typeof obj[method])throw new Error("cannot map channel "+channel+", missing method "+method);this.channel(channel).subscribe(obj[method].bind(obj))}},_p.q_findIndex=function(time){for(var i=0;i<this.messages.length;i++)if(this.messages[i][0]>time)return i;return null},_p.pushAt=function(time,payload){var message=[time,payload];if(time>=this.q.latestTime||!this.messages.length)this.q.latestTime=time,this.messages.push(message);else if(this.messages[0][0]>time)this.messages.unshift(message);else{var i=this.q_findIndex(time);this.messages.splice(i,0,message)}return this},_p.pushIn=function(dt,payload){return this.pushAt(this.q.currentTime+dt,payload)},_p.fetchAt=function(time){return this.messages.length&&this.messages[0][0]<=time?this.messages.shift()[1]:null},_p.fetch=function(payload){return this.fetchAt(this.q.currentTime)},_p.fetchAllAt=function(time){for(var message,result=[];;){if(message=this.fetchAt(time),null===message)break;result.push(message)}return result},_p.fetchAll=function(time){return this.fetchAllAt(this.q.currentTime)},_p.broadcastAt=function(time,payload){if(null===this.m_channel)throw new Error("cannot broadcast without channel modifier");return this.pushAt(time,[this.m_channel,payload]),this},_p.broadcastIn=function(dt,payload){return this.broadcastAt(this.q.currentTime+dt,payload)},_p.run=function(){for(;;){var message=this.fetch();if(!message)break;"function"==typeof message?message():this.channel(message[0]).broadcast(message[1])}},_p.channel=function(channel){return this.channelAndAudience(channel,this.m_audience)},_p.audience=function(audience){var audienceIndex=this.audiences.indexOf(audience);return-1==this.audiences.indexOf(audience)&&(this.audiences.push(audience),audienceIndex=this.audiences.length-1),this.channelAndAudience(this.m_channel,audienceIndex)},_p.channelAndAudience=function(channel,audience){var key=channel||"";if(void 0!==audience&&(key+=":"+audience),!this.channels[key]){var o=clone(this);o.m_channel=channel,o.m_audience=void 0===audience?null:audience,this.channels[key]=o}return this.channels[key]},_p.timeAt=function(time){return this.q.currentTime=time,this},_p.timeIn=function(dt){return this.q.dt=dt,this.q.currentTime+=dt,this},PreparedBroadcast.prototype.execute=function(){return this.filler(this.template,arguments),this.r.broadcast(this.template)},PreparedBroadcast.prototype.executeAt=function(){var event=clone(this.template),j=1;for(var i in event)event[i]=arguments[j++];return this.r.broadcastAt(arguments[0],event),this},PreparedBroadcast.prototype.executeIn=function(){return arguments[0]=this.r.q.currentTime+arguments[0],this.executeAt.apply(this,arguments)},module.exports=Radiopaque;

return module.exports;
})();
